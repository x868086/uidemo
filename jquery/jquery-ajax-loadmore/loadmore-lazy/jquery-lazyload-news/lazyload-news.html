<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style type="text/css">
        div,p,h5,ul,li,img,a{
            margin:0px;
            padding:0px;
        }

        ul,li{
            list-style:none;
        }

        a{
            text-decoration:none;
            color:black;
        }

        .clearfix:after{
            content:"";
            display:block;
            clear:both;
        }

        #container{
            width:600px;
            margin:0 auto;
            border:1px solid green;
        }

        .newsview{
            margin-top:20px;
        }

        .newsview img{
            width:60px;
            height:60px;
            float:left;
        }

        .newsview h5,p{
            margin-left:10px;
            margin-top:5px;
            float:left;
        }

        p{
            color:#aaa;
            font-size:14px;
        }
        </style>
        <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.9.1/jquery.js">
        </script>
    </head>
    <body>
    <div id="container">
            <ul>
                <!-- <li class="newsview">
                    <a href="http://xw.qq.com/mil/20160830028700/MIL2016083002870002" class="clearfix">
                        <img src="http://inews.gtimg.com/newsapp_ls/0/531644649_150120/0" alt="">
                        <h5>西媒臆断老挝“弃华投美” 认为现政府更亲越南</h5>
                        <p>西媒臆断老挝“弃华投美” 认为现政府更亲越南</p>
                    </a>
                </li> -->
            </ul>
            <p class="load-flag">加载更多</p>
    </div>
    <script>
        /*tips思路：1.设置一个加载更多的元素放在li的最下方，当这个元素scroll时或者初始状态时出现在window视窗可视范围内时执行ajax请求
        2.ajax请求，发送页数，后台返回固定个数的新闻清单+数据状态码，状态码标识数据返回是否出错
        3.前台获取到后台传来的数据拼装成DOM元素插入到ul底部
        4.当返回数据为空时在ul底部插入p标签显示数据加载完了
        5.用visibility:hidden隐藏加载更多标签，因为用display:none元素会脱离文档流始终处于window可视窗口*/
    $(window).ready(function(){
        var $node=$(".load-flag"),
            idx=0;

            lazyLoad();
        // var loading
        //     $(window).on("scroll",function(){
        //         if(loading){
        //             clearTimeout(loading)
        //         }
        //         loading=setTimeout(function(){
        //             lazyLoad();
        //         },500)
        //     })

        $node.on("click",function(){
           lazyLoad(); 
        })

            function lazyLoad(){
                if(isShow($node)){
                    loadImg();
                }
            }
            

            function isShow($node){
                var scrollY=$(window).scrollTop(),
                    windowHeight=$(window).height(),
                    offsetY=$node.offset().top
                if(offsetY < scrollY +windowHeight && offsetY >scrollY){
                    return true;
                }else{
                    return false;
                }
            }


            function loadImg(){
                $.ajax({
                    url:"/getmore",
                    method:"GET",
                    data:{"pageIndex":idx},
                    dataType:"html"})
                    .done(function(res){
                        var newsArr=JSON.parse(res)
                        renderHtml(newsArr)
                    })
                    .fail(function(){
                            console.log("加载出错")
                        })
            }

            function renderHtml(newsArr){
                var newsHtml=""
                newsArr.forEach(function(e,i,a){
                            newsHtml += 
                                `<li class="newsview">
                                    <a href=${e.link} class="clearfix">
                                    <img src=${e.img} alt="">
                                    <h5>${e.title}</h5>
                                    <p>${e.brif}</p>
                                    </a>
                                </li>`
                        })
                console.log(newsHtml)
                idx ++
                $("#container ul").append($(newsHtml))
                        
                /*lazyLoad() tips1:页面初始环境下加载一次且数据渲染后内容太少，无法滚动所以要在渲染html执行完成后再执行一次lazyLoad判断并加载*/
            }
            

})
    </script>
    </body>
</html>