<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style type="text/css">
        div,p,h5,ul,li,img,a{
            margin:0px;
            padding:0px;
        }

        ul,li{
            list-style:none;
        }

        a{
            text-decoration:none;
            color:black;
        }

        .clearfix:after{
            content:"";
            display:block;
            clear:both;
        }

        #container{
            width:600px;
            margin:0 auto;
        }

        .newsview{
            margin-top:20px;
        }

        .newsview img{
            width:60px;
            height:60px;
            float:left;
        }

        .newsview h5,p{
            margin-left:10px;
            margin-top:5px;
            float:left;
        }

        .load-flag{
            color:#aaa;
            font-size:14px;
            visibility:hidden;
        }
        </style>
        <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.9.1/jquery.js">
        </script>
    </head>
    <body>
    <div id="container">
            <ul>
                <!-- <li class="newsview">
                    <a href="http://xw.qq.com/mil/20160830028700/MIL2016083002870002" class="clearfix">
                        <img src="http://inews.gtimg.com/newsapp_ls/0/531644649_150120/0" alt="">
                        <h5>西媒臆断老挝“弃华投美” 认为现政府更亲越南</h5>
                        <p>西媒臆断老挝“弃华投美” 认为现政府更亲越南</p>
                    </a>
                </li> -->
            </ul>
            <p class="load-flag">加载更多</p>
    </div>
    <script>
        /*tips思路：1.设置一个加载更多的元素放在li的最下方，当这个元素scroll时或者初始状态时出现在window视窗可视范围内时，而且后台传回数据不为
        空时，执行载入图片的函数
        2.载入图片函数执行发起ajax请求，发送页数，目标获取后台返回固定个数的新闻清单+数据状态码，状态码标识数据返回是否出错
        3.获取到后台传来的数据后执行html渲染函数拼装成DOM元素插入到ul底部，此时先判断传回数据是否为空，为空则在ul底部插入p标签显示数据加载完了
        4。用visibility:hidden隐藏加载更多标签，因为用display:none元素会脱离文档流始终处于window可视窗口*/
    $(window).ready(function(){
        var $node=$(".load-flag"),
            idx=0,
            isover=false

            lazyLoad();

        var loading
            $(window).on("scroll",function(){
                if(loading){
                    clearTimeout(loading)
                }
                loading=setTimeout(function(){
                    lazyLoad();
                },1000)
            })

        // $node.on("click",function(){
        //    lazyLoad(); 
        // })

            function lazyLoad(){
                if(isShow($node) && !isover){ /*tips1:标记元素出现在window视窗范围内，且返回的数据没有为空（还有内容时）执行加载图片函数*/
                    loadImg();
                }
            }
            

            function isShow($node){
                var scrollY=$(window).scrollTop(),
                    windowHeight=$(window).height(),
                    offsetY=$node.offset().top
                if(offsetY < scrollY +windowHeight && offsetY >scrollY){
                    return true;
                }else{
                    return false;
                }
            }

            

            function loadImg(){
                $.ajax({
                    url:"/getmore",
                    method:"GET",
                    data:{"pageIndex":idx},
                    dataType:"html"})
                    .done(function(res){
                        var newsArr=JSON.parse(res)
                        if(newsArr.status===1){ /*tips2:返回的数据状态为1是即正常，将页码+1且执行html渲染函数*/
                            idx ++
                            renderHtml(newsArr.data) 
                        }                      
                        
                    })
                    .fail(function(){
                            console.log("加载出错")
                        })
            }

            function renderHtml(newsArr){
                if(newsArr.length===0){/*tips3:如果返回内容为空则表示后台数据没有了，这时候插入提示p标签*/
                    isover=true;
                    $("#container").append($(`<p>没有数据了</p>`))
                        return
                }

                var newsHtml=""
                newsArr.forEach(function(e,i,a){
                            newsHtml += 
                                `<li class="newsview">
                                    <a href=${e.link} class="clearfix">
                                    <img src=${e.img} alt="">
                                    <h5>${e.title}</h5>
                                    <p>${e.brif}</p>
                                    </a>
                                </li>`
                        })
                // console.log(newsHtml)
                console.log("加载成功")
                $("#container ul").append($(newsHtml))
                        
                lazyLoad() /*tips4:页面初始环境下加载一次且数据渲染后内容太少，无法滚动所以要在渲染html执行完成后再执行一次lazyLoad判断并加载*/
            }
            

})
    </script>
    </body>
</html>